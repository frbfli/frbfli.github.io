<!DOCTYPE html>
<html>
<head>
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="yes" name="mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta content="user-scalable=no" name="viewport">
	<title>Guild Ball Terrain Generator</title>
</head>
<body onload="preLoad()">
	<input type="button" id="generate" value="Generate" onclick="generate()" />
	<div id="container" style="margin: 0px auto; transform: translate(-50%, -50%); position: absolute; top: 50%; left: 50%; width: 300px;">
		<canvas id="map" width="360" height="360" style="border:1px solid black; transform: scale(2.5);"></canvas>
		<img src="images/ba.png" id="ba" style="display:none;" />
		<img src="images/fg.png" id="fg" style="display:none;" />
		<img src="images/fo.png" id="fo" style="display:none;" />
		<img src="images/ob.png" id="ob" style="display:none;" />
		<img src="images/rg.png" id="rg" style="display:none;" />
	</div>
	<script>
		var c = document.getElementById("map");
		var ctx = c.getContext("2d");

		var Terrain = function(type, x, y, size, midX, midY) {
			this.type = type;
			this.x = x;
			this.y = y;
			this.size = size;
			this.midX = midX;
			this.midY = midY;
		}

		var TerrainType = function(name, size) {
			this.name = name;
			this.size = size;
		}

		var terrainArray = [];

		var types = [
			"fast",
			"rough",
			"forest",
			"obstruction",
			"barrier"
		];

		var type = [];

		var loc = [];

		var checkAttempt = 0;

		function rando(min, max) {
			var n = Math.floor(Math.random() * (1 + max - min)) + min;
			return n;
		}

		function setTypes(check) {
			// get number of ground/terrain pieces
			var n = rando(4,6);

			// get number of obstructions (50%+)
			var ob = Math.ceil(n / 2);

			// set counters for barrier, forest, and fast ground types
			var barrier = 0;
			var forest = 0;
			var fast = 0;

			// get ground/terrain type for each piece
			for (var i = 0; i < n; i++) {
				if (i < ob) {
					type[i] = "obstruction";
				}
				else {
					// choose a random ground/terrain type
					type[i] = types[rando(0,types.length - 1)];
					// redo if result is second barrier, second forest, or third fast ground
					while(barrier > 0 && type[i] == "barrier" || forest > 0 && type[i] == "forest" || fast > 1 && type[i] == "fast") {
						type[i] = types[rando(0,types.length - 1)];
					}
					// if result is barrier, increase barrier counter
					if (type[i] == "barrier") { barrier++; }
					// if result is forest, increase forest counter
					else if (type[i] == "forest") { forest++; }
					// if result is fast ground, increase fast ground counter
					else if (type[i] == "fast") { fast++; }
				}
				genCoords(type[i]);
			}
		}

		function genCoords(tempTerrain) {
			var x, y, size, coin;
			var canPlace = false;

			// while (!canPlace) {
				var checkPlace;
				// for (var i = 0; i < type.length; i++) {
				if (tempTerrain == "fast") {
					coin = Math.floor(Math.random() * 2) + 1;  
					if (coin < 2) {
						x = Math.floor(Math.random() * 30) + 1;
					} else {
						x = Math.floor(Math.random() * (360-330+1)) + 330;
					}
					size = 3;
				}
				else {
					x = Math.floor(Math.random() * (360)) + 1;
					switch (tempTerrain) {
						case 'rough':
							size = 6;
							break;
						case 'forest':
							size = 6;
							break;
						case 'barrier':
							size = 4;
							break;
						default:
							size = 4;
							break;
					}
				// }
				y = Math.floor(Math.random() * (300 - 100 + 1)) + 100;
				var tempCoords = [];
				tempCoords.x = x;
				tempCoords.y = y;
				tempCoords.size = size;
				tempCoords = fixTerrain(tempCoords);
				if (terrainArray.length != 0) { 
					checkPlace = checkCollision(tempCoords);
					if (checkPlace) {
						terrainArray.push(new Terrain(tempTerrain, tempCoords.x, tempCoords.y, tempCoords.size, tempCoords.midX, tempCoords.midY));
						checkAttempt = 0;
					} else {
						checkAttempt += 1;
						if(checkAttempt <= 50) {
							genCoords(tempTerrain);
						}
					}
				} else {
					terrainArray.push(new Terrain(tempTerrain, tempCoords.x, tempCoords.y, tempCoords.size, tempCoords.midX, tempCoords.midY));
					checkAttempt = 0;
				}
				
				
			}
			// }
		}

		function fixTerrain(t) {
			if (t.x + (t.size * 10) >= 360) {
				t.x = 360 - (t.size * 10);
			}
			if (t.y + (t.size * 10) >= 300) {
				t.y = 300 - (t.size * 10);
			}

			t.midX = t.x + ((t.size * 10) / 2);
			t.midY = t.y + ((t.size * 10) / 2);

			return t;
		}

		function paintTerrain() {
			var image;
			for (i in terrainArray) {
				switch(terrainArray[i].type) {
					case 'fast':
						image = "fg";
						break;
					case 'rough':
						image = "rg";
						break;
					case 'forest':
						image = "fo";
						break;
					case 'obstruction':
						image = "ob";
						break;
					case 'barrier':
						image = "ba";
						break;
				}

				var img = document.getElementById(image);
				ctx.drawImage(img, terrainArray[i].x, terrainArray[i].y);
			}
		}

		function checkCollision(c) {
			var t = terrainArray;
			var checkHere;
			var size2 = c.size * 10;
			var rect2 = {
				x: c.x - 60,
				y: c.y - 60,
				w: size2 + 60,
				h: size2 + 60
			}
			for (i in terrainArray) {
				var size1 = terrainArray[i].size * 10;
				var rect1 = {
					x: terrainArray[i].x - 60,
					y: terrainArray[i].y - 60,
					w: size1 + 60,
					h: size1 + 60
				}
				checkHere = rectsColliding(rect1, rect2);
				if (!checkHere) {
					return checkHere;
				}
			}
			return checkHere;
		}

		function rectsColliding(rect1, rect2) {
			if (rect1.x < rect2.x + rect2.w &&
			   rect1.x + rect1.w > rect2.x &&
			   rect1.y < rect2.y + rect2.h &&
			   rect1.h + rect1.y > rect2.y) {
			   return false;
			} else {
			   return true;
			}
		}

		function preLoad() {

			var windowHeight = window.innerHeight;
			var windowWidth = window.innerWidth;

			var contentWidth = document.getElementById('container').offsetWidth;
			var contentHeight = contentWidth;
			var buffer = 0;
			
			if (contentHeight > windowHeight) {
				buffer = contentWidth - windowHeight;
				contentHeight = windowHeight;
				contentWidth = contentHeight;
			}

			document.getElementById('container').style.height = contentHeight;
			document.getElementById('container').style.width = contentWidth;

			setTypes();
			paintTerrain();

		}

		function generate() {
			terrainArray = [];
			type = [];
			loc = [];
			checkAttempt = 0;

			ctx.clearRect(0,0,c.width, c.height);
			setTypes();
			paintTerrain();
		}

	</script>
</body>
</html>